## 虚拟交换机

目录

  * [虚拟网络设备](#虚拟网络设备)
  * [Overlay网络](#Overlay网络)
  * [五种网络类型](#五种网络类型)
  * [Linux网桥机制驱动](#Linux网桥机制驱动)
  * [OVS机制驱动](#OVS机制驱动)

在本节中，将介绍Neutron所依赖的网络概念和架构，以及提供与实例的连接和扩展ML2网络插件功能的多种机制驱动程序：LinuxBridge，Open vSwitch和L2群集驱动程序。

### 虚拟网络设备

* tap接口

    OpenStack使用libvirt KVM/QEMU驱动程序作为Nova中默认程序来提供平台虚拟化。 当实例首次启动时，Neutron会为实例的每个网络接口分配一个虚拟端口。 KVM将在计算节点上创建一个名为tap接口的虚拟网络接口。 **tap接口接口直接对应于实例中的网络接口**。 通过使用网桥，主机可以将实例暴露给物理网络。

* Linux网桥

    Linux网桥是连接多个网络接口的虚拟交换机。 当使用Neutron时，网桥通常将物理接口连接到一个或多个虚拟接口或物理接口。 物理接口包括以太网接口，例如eth1。 虚拟接口包括VLAN接口，如eth1.100，以及由KVM创建的tap接口。

![虚拟网络设备](http://on64c9tla.bkt.clouddn.com/Neutron/Virtual_Nework_Devices.png)

图中brqXXX代表Linux网桥，上面连接了一个物理接口，即eth1，以及三个虚拟接口，即tap0,tap1,tap2。三个虚拟接口分给代表三个实例的网络接口。

OSV网桥是基于软件实现的一种虚拟网桥，利用流表规则负责对数据包的转发。Neutron中可以配置三个OVS网桥或交换机，包括 **一般网桥、集成网桥和隧道网桥**。

### Overlay网络

Neutron中支持Overlay网络技术，为了实现这一点，Neutron利用L2-in-L3覆盖网络技术，如GRE和VXLAN。通过相应的配置，Neutron可以将云环境中的所有网络和计算节点之间建立点对点隧道。

注意：使用Overlay网络时，MTU(最大传输单元)的设置需要得到关注。

### 五种网络类型

根据前面的介绍，ML2插件支持五种网络类型，现在分别进行介绍。

* local网络

    **本地网络是指与其他网络和节点隔离的网络**。 连接到本地网络的实例可以与同一计算节点上的同一网络中的其他实例通信，但可能无法与位于另一个主机上的同一网络中的实例通信。

* flat网络

    **flat网络是指不带有VLAN标记或其他网络隔离技术的普通网络**。

* VLAN网络

    **VLAN网络是利用802.1q标记来隔离网络流量的网络**。 同一个VLAN中的实例被认为是同一个网络的一部分，位于相同的2层广播域中。 **不同VLAN之间的路由只能通过使用路由器进行**。

* VXLAN网络

    **VXLAN网络是指利用唯一分段ID(称为VNI)来区分不同VXLAN网络的流量的网络**。 从一个实例出发数据包，先利用VNI进行封装，并借助3层的UDP协议到达另一个实例，通过相应的解封装获得数据报。**使用VXLAN技术是为了解决VLAN和物理交换基础设施的局限性**。

* GRE网络

    **GRE网络与VXLAN网络类似，也是通过3层网络封装进行数据报的转发**。GRE网络不是使用UDP作为传输机制，而是使用IP协议。

### Linux网桥机制驱动

当使用Linux网桥作为机制驱动进行网络实现时，Neutron支持五种网络接口：

+ tap接口
+ 物理接口
+ VLAN接口
+ VXLAN接口
+ LinuxBridge

在前面的介绍中已经包含了tap接口的相关知识，这里不再赘述。物理接口比较简单，也不再进行介绍。下面主要介绍一下VLAN接口和VXLAN接口。

Linux通过使用虚拟VLAN接口支持802.1q VLAN标记。 可以使用iproute2命令或传统的vlan程序和8021q内核模块创建VLAN接口。 VLAN接口通常标注为ethX.<vlan>，并与其各自的物理接口ethX相关联。

VXLAN接口是一种虚拟接口，用于根据配置的参数（例如VXLAN网络标识符（VNI）和VXLAN隧道端点（VTEP））来创建接口。 VTEP的功能是通过IP网络将虚拟机实例流量封装在IP报头中。 数据包使用VNI提供的ID与其他VXLAN流量隔离。

Linux网桥也是一种虚拟接口，可以连接一个或多个虚拟接口或物理接口，是 **虚拟交换机的一种形式**。

### OVS机制驱动

OSV网桥是基于软件实现的一种虚拟网桥，利用流表规则负责对数据包的转发。OVS中主要包含三个组件：内核模块、OVS后台进程和数据库服务。当使用OVS作为机制驱动进行网络实现时，Neutron支持五种不同的虚拟网络设备：

+ tap设备
+ Linux网桥
+ veth设备，即虚拟网络设备对
+ OVS网桥
+ OVS patch端口

veth设备，即虚拟网络设备对，一般成对使用，用于连接两个不同网络命名空间的网络设备。当一端发送数据时，另一同样也会受到相同的数据，类似网络电缆。

OVS网桥也是一种虚拟网络设备，扮演虚拟交换机的角色。Neutron中将DHCP服务、路由器服务、实例接口等接口连接到OVS网桥上。

Open vSwitch具有内置的端口类型，类似veth设备，但是它已经针对OVS网桥进行了优化，称为patch端口。 当连接两个Open vSwitch网桥时，每个交换机上的都有一个保留端口作为patch端口。 patch端口配置了一个对等体名称，对应于另一个交换机上的patch端口。
