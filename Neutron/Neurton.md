## Neutron介绍

目录：

  * [基本网络元素](#基本网络元素)
  * [ML2插件](#ML2插件)
  * [网络命名空间](#网络命名空间)

### 基本网络元素

Neutron中使用包括网络，子网，端口，路由器，负载平衡器等元素来构建构建虚拟网络。

* 网络

    网络是指一个独立的二层广播域。通常由租户创建，并可以通过相应配置，在租户之间共享网络。 网络是Neutron API的核心实体。**子网和端口必须始终与网络相关联**。

* 子网

    子网是指IPv4或IPv6地址段，IP地址可分配给虚拟机实例。 每个子网必须具有CIDR(Classless Inter-Domain Routing：无类别域间选由）并且必须与网络相关联。 多个子网可以与单个网络相关联，并且可以是不连续的。

* 端口

    Neutron中的一个端口表示逻辑虚拟交换机上的虚拟交换机端口。 虚拟机(实例)接口映射到Neutron端口，端口中定义了要分配的MAC地址和IP地址。 Neutron的端口定义存储在Neutron数据库中，然后由相应的插件代理程序用于构建和连接虚拟交换基础架构。

为了更好地支持网络服务，Neutron允许并支持第三方插件和驱动程序来扩展Neutron API。在现有的Neutron架构中，主要包含两种类型的插件：**核心插件** 和 **服务插件**。核心插件主要在Neutron的API中实现，通过网络、子网以及端口等对逻辑网络进行实现和管理。本书中主要探讨核心插件中 **模块二层插件(Modular Layrer 2，简称ML2)** 的技术实现与原理。而服务插件主要扩展网络服务，比如路由、负载均衡、防火墙等。在本书的后半部分，主要探讨服务插件中的 **路由、负载均衡、防火墙、虚拟专用网络**。

### ML2插件

ML2插件引入了 **类型驱动(Type Drivers)** 和 **机制驱动(Mechanism Drivers)** 的概念，用以区分正在实现的网络类型以及实现这些类型的网络的机制。

**类型驱动**

ML2中类型驱动用来维护类型特定的网络状态，验证网络属性，并利用网络属性来描述网段。 网络属性包括网络接口标签，分段ID和网络类型。 目前支持的网络类型包括 **local、flat、vlan、vxlan和gre**。

**机制驱动**

ML2中机制驱动负责利用类型驱动建立的信息来确保其网络的正确实施。 目前支持的机制驱动包括 **LinuxBridge、Open vSwitch和L2 Population**。

LinuxBridge（Linux网桥）和Open vSwitch（OVS）机制驱动用来配置网络接节点上实例和网络服务的交换机技术。Linux网桥支持local、flat、vlan和vxlan网络类型；而OVS支持local、flat、vlan、vxlan和gre网络类型。

L2 Population驱动用于限制跨 **覆盖网络(Overlay Network)** 转发的广播流量的数量。 传统的交换机中规定，未知的单播，组播和广播流量将被输出到所有交换机端口，直到该位置被学习为止。 这种行为可能对覆盖网络结构产生负面影响，特别是随着云中主机数量的扩大。 作为云端存在哪些实例和其他网络资源的权威机构，Neutron可以预先在所有主机上预先转发数据库，以避免昂贵的学习成本。 当使用ARP代理时，Neutron以类似的方式在所有主机上预处理ARP表，以避免ARP流量在覆盖结构中广播。

**ML2架构**

下图显示了Neutron API服务如何与负责构建虚拟和物理网络的各种插件和代理进行交互：

![ML2架构](http://on64c9tla.bkt.clouddn.com/Neutron/ML2.png)

### 网络命名空间

OpenStack的设计考虑到了多租户，并为用户提供创建和管理自己的计算和网络资源的能力。 Neutron支持具有多个专用网络，路由器，重定向器，负载平衡器和其他网络资源的每个租户。 它能够通过使用网络命名空间来隔离这些对象中的许多对象。

**网络命名空间被定义为具有自己的路由，重定向规则和网络接口设备的网络堆栈的逻辑副本**。 当使用开源参考插件和驱动程序时，每个网络，路由器和负载均衡器由用户创建的由网络命名空间表示。 当启用网络命名空间时，Neutron能够为每个网络提供隔离的DHCP和路由服务。 这些服务允许用户与其他项目中的其他用户甚至同一项目中的其他网络创建重叠的网络。

Neutron中主要包含三种网络命名空间：

* DHCP命名空间：qdhcp-<network UUID>
* Router命名空间：qrouter-<router UUID>
* Load Balancer命名空间：qlbaas-<load balancer UUID>

**DHCP命名空间代表一个DHCP服务器，负责通过DHCP协议向实例提供IP地址**。在参考实现中，dnsmasq是处理DHCP请求的线程。 qdhcp命名空间具有接入到虚拟交换机中的接口，并且能够与同一网络或子网中的实例和其他设备进行通信。 qdhcp命名空间为每一个网络所创建，并对关联到该网络的子网提供DHCP服务。

**Router命名空间代表一个虚拟路由，负责对子网中的实例进行数据包的路由转发操作**。与DHCP命名空间一样，Router命名空间也连接至一个或多个虚拟交换机。

**Load Balancer命名空间代表一个虚拟负载均衡器，负责对实例的流量进行负载均衡**。LB命名空间连续到虚拟交换机上，可以与同一个网络或子网的设备或实例进行通信。
