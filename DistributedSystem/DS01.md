## 分布式系统

本章主要介绍分布式系统的基础理论，包括数据分布，复制协议，一致性，容错和分布式协议。

数据分布是指考虑到各个节点的负载情况，需要将数据均匀的的分布在各节点上；同时，为了保证可靠性和可用性，需要将数据复制多个副本，也就是数据的一致性问题。分布式系统中两个重要的协议：**两阶段提交协议** 和 **Paxos协议**。两阶段提交协议用于保证跨多个节点操作的原子性(要么全部成功，要么全部失败)；Paxos协议用于解决多个节点的数据一致性问题。

### 基本概念

1.**异常**

1）服务器宕机  
**服务器宕机重启后，节点将失去所有的内存信息**。因此，需要考虑使用持久化存储介质来恢复内存信息，保证服务器重启后恢复到某个一致状态。

2）网络异常  
网络异常通常造成各节点间的通信出现故障。因此，一个基本原则就是任何一个消息只有收到对方的回复，才能确认发送成功。当然，也可利用超时机制进行相应的限制。

3）磁盘故障  
磁盘故障分为两种：磁盘损坏和磁盘数据错误。磁盘损坏可利用其他备份数据进行恢复；磁盘数据错误可利用校验和机制。

2.**超时**

分布式系统中的“三态”："成功","失败","超时"。面对超时现象，可以利用“幂等”操作，即操作执行一次与执行多次的结果相同。

!["三态"](http://on64c9tla.bkt.clouddn.com/Comput/timeout.png)

3.**一致性**

分布式存储系统中为了保证数据可靠性和可用性，一般进行冗余备份，即一份数据在分布式系统中包含多个副本数据。**副本可以说是分布式系统容错技术的唯一手段**。那么，保证副本之间的一致性问题是分布式系统的核心理论。

一致性问题的两个角度，**用户** 和 **存储系统**。从用户角度看包含三种，1）强一致性，是指某个写操作后，后序的读取操作均返回最新值；2）弱一致性，是指某个写操作后，后序的读取操作，存储系统不保证返回最新值；3）最终一致性，是弱一致性的特例，即经过"不一致窗口"时间后，存储系统返回最新值。最终一致性的几个变种，读写一致性，会话一致性，单调读一致性，单调写一致性。从存储系统角度看，包含两种，1）副本一致性和2）更新顺序一致性。

一般而言，存储系统可以支持强一致性，也可以支持最终一致性；从用户角度来看，一般要求存储系统支持读写一致性，会话一致性，单调读一致性，单调写一致性。

### 数据分布

数据分布的方式主要有两种，一是哈希分布，即根据 **数据的某个特征** 计算出哈希值，并将哈希值与集群中的服务建立 **映射关系**，从而将不同哈希值的数据分布到不同的服务器上；一是顺序分布，一种类似B+树的数据分布方式。

1.**哈希分布**  
哈希分布要求哈希函数的散列性要好，这样数据才能较均匀的分布到不同的集群服务器上。传统的哈希分布算法中，当服务器上线或下线时，数据映射关系被全部打乱，几乎所有的数据需要重新分布，产生大量的数据迁移。**其解决思路有两种**，一种是将哈希值与服务器的映射关系作为 **元数据**，存储在元数据服务器，然后通过元数据服务器管理其他存储服务器；另一种是采用 **一致性哈希算法**。

*一致性哈希算法的思想是给系统中每个节点分配一个随时的token，这些token构成一个哈希环。执行数据存放操作时，先计算主键的哈希值，然后存放到顺时针方向第一个大于或者等于该哈希值的token所在的节点*。其优点是节点在加入/删除时只会影响到哈希环中相邻的节点，而对其他节点没有影响。

补充：改进的一致性哈希算法(虚拟节点)

其思想是每个物理节点根据其性能的差异分配多个token，每个token对应一个“虚拟节点”。每个虚拟节点的处理能力相当，并随机分布到哈希空间中。存储时，数据按照哈希值落到某个虚拟节点负载的区域，然后存储到该虚拟节点对应的物理节点中。例如Amazon Dynamo分布式键值系统中的改进的一致性哈希算法。

![Dynamo虚拟节点](http://on64c9tla.bkt.clouddn.com/Comput/dynamo-hash.png)

值得注意的是，哈希分布只支持随机读取操作，不支持顺序扫描。

2.**顺序分布**  
顺序分布在分布式表格系统中较为常见，其做法是将大表顺序划分为连续的范围，每个范围称为一个子表。总控节点负责将字表通过一定的策略分配到不同的集群服务器上。

存在的问题是随着数据的插入和删除，子表的分裂和合并增加个系统的复杂度。

3.**负载均衡**  
分布式系统中一般包括一个总控节点，其他节点称为工作节点(通过心跳包向总控节点上报自身的负载信息)。总控节点根据全局负载信息进行整体调度。负载均衡需要执行数据迁移操作。分布式系统中的存储数据一般包括 **主副本** 和 **备副本**，由主副本向外提供服务，迁移备副本对服务没有影响。

示例：数据分片D有两个副本D1(主副本)和D2(备副本)，分别存储在工作节点A1和工作节点A2，先需要将D1中工作节点A1迁移出去，其操作步骤如下：

1）将数据分片D的读写服务由工作节点A1切换至工作节点A2,D2变为主副本；  
2）选择某个节点，增加副本D3，并与D2保持同步；  
3）删除工作节点中A1中的D1。

### 复制

分布式系统为了提供高可用性和高可靠性，数据在系统中一般存储多个副本。当某个副本所在的节点故障时，分布式系统能够自动将服务切换至其他副本，从而使实现自动容错。复制协议将数据同步到多个存储节点，并确保多个副本数据的一致性。

复制协议分为两种，强同步复制和异步复制，二者的区别在于用户的写请求是否需要同步到副本才返回成功。强同步复制协议可以保证主备副本之间的一致性，但是当备副本出现故障时，也可能阻塞存储系统正常的读写服务，可用性较差；异步复制协议可用性较好，但一致性得不到保障，但主副本出现故障时，可能造成数据丢失。

**基于主副本的复制协议**，即将主副本的数据通过某种形式发送给备副本。强同步复制和异步复制均采用这个机制。**成组提交**，即当操作日志积累到一定量时，系统再批量写入磁盘中。

### 一致性与可用性的探讨

CAP理论：一致性(Consistency)，可用性(Availability)，网络分区容忍性(Partition)，三者不能同时满足。

一致性：读取操作总能获取之前写操作的最新结果。  
可用性：发生单机故障时，存储系统仍然可用。  
分区容忍性：出现异常时，存储系统仍满足一致性和可用性。

为了权衡分布式系统的一致性和可用性，有三种模式可选：

**最大保护模式**：强同步复制模式。写操作要求主副本先将操作日志同步到至少一个备副本，才返回用户成功信息。

**最大性能模式**：异步复制模式。写操作只需要在主副本操作成功就返回用户成功信息，之后再将操作日志异步复制到备副本。

**最大可用性模式**：正常情况下相当于最大保护模式，当主备之间网络出现故障时，切换至最大性能模式。

### 容错
