## 分布式键值系统

分布式键值模型是分布式表格模型的一种特例，一般只支持单个key-value的“增、删、查、改”操作，因此适用 **哈希分布算法**。Amazon Dynamo是分布式键值系统，学习Dynamo的设计思想，设计原则，对理解分布式系统理论很有帮助。

### 1. Amazon Dynamo

Dynamo以简单的键值方式存储数据，且存储的是数据的原始形式，不解析数据的内容。以下是Dynamo设计中面临的问题及解决方案，接下来依次查看。

![Dynamo设计](http://on64c9tla.bkt.clouddn.com/Comput/dynamo.png)

**1.1 数据分布**

改进的一致性哈希算法(也称为一致性哈希表，简称DHT)的思想是：每一个物理节点根据其性能的差异分配多个token，**每个token对应一个“虚拟节点”**。每个虚拟节点的处理能力相当，并 **随机分布** 在哈希空间中，存储时，数据根据哈希值落在某个虚拟节点的负责的区域中，然后被存储在该虚拟节点对应的物理节点上。

![改进的哈希一致性算法](http://on64c9tla.bkt.clouddn.com/Comput/dynamo_hash.png)

为了找到数据所属的节点，Dynamo系统中 **每个节点维护整个集群的信息**，客户端也缓存整个集群的信息。与此同时，为了保证每个节点缓存是Dynamo系统中最新的集群信息，**所有节点每隔固定时间** 通过 **Gossip协议** 从其他节点中任意一个与之通信的节点。如果连接成功，**双方交换各自保存的集群信息**。

【补充】：Gossip协议

Gossip协议用于P2P系统中自洽的节点协调对整个集群的认识，比如集群的节点，负载情况等。一个简单的例子是这样的(集群中节点A和节点B交换对集群的认识)。

1）A告诉B其管理的所有节点的版本（包括Down状态和Up状态的节点）  
2）B告诉A哪些版本比较旧，哪些版本它有最新的，然后把那些最新的版本发给A（处于Down状态下的版本由于没有更新，所有不会被关注）  
3）A将B中比较旧的版本发给B，同时将B发来的最新节点信息做本地更新  
4）B收到A发来的最新节点信息，然后做本地更新  

**1.2 一致性和复制**

Dynamo系统中对副本的管理思想是：假设数据存储N份，DHT定位到数据存储所属的节点K，则将数据存储在节点K, K+1, ..., K+N-1.
